name: Development Publish

on:
        push:
                branches: [development]
        workflow_dispatch:

env:
        assetId: 17276169355

jobs:
        build:
                name: build
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@v4.1.1
                        - uses: actions/setup-dotnet@v4
                          with:
                                  dotnet-version: 7.0
                        - uses: actions/setup-node@v4
                          with:
                                  node-version: 21
                        - uses: leafo/gh-actions-lua@v10
                          with:
                                  luaVersion: luajit

                        - uses: leafo/gh-actions-lua@v10
                          with:
                                  luaVersion: 5.1

                        - name: Apply fix to luajit
                          working-directory: .lua/bin
                          run: mv luajit* luajit

                        - name: Set up production version for rojo
                          run: mv release.project.json default.project.json

                        - uses: ok-nick/setup-aftman@v0.4.2
                          with:
                                  token: ${{ secrets.GITHUB_TOKEN }}

                        # - name: Build Obfuscator
                        #   working-directory: yolus-source
                        #   run: dotnet build

                        # - name: Publish Obfuscator
                        #   working-directory: yolus-source
                        #   run: dotnet publish --output ../Obfuscator

                        - name: Obfuscate Source Files
                          working-directory: Obfuscator
                          run: dotnet YolusCLI.dll

                        - name: Build
                          run: rojo build -o vsds-${{ github.ref_name }}.rbxm

                        #- name: Release changelog to Discord
                        #  uses: tsickert/discord-webhook@v6.0.0
                        #  with:
                        #          webhook-url: ${{ secrets.VSDS_WEBHOOKKEY }}
                        #          filename: vsds-${{ github.ref_name }}.rbxm
                        #          wait: true
                        #          username: '@Github'
                        #          avatar-url: https://avatars.githubusercontent.com/u/97051909

                        - name: Create .env for CRSF container
                          working-directory: crsf
                          run: echo "ROBLOXCOOKIE=${{ secrets.VSDS_ROBLOXSECURITYKEY }}" > .env

                        - name: Setup CRSF container
                          working-directory: crsf
                          run: yarn install

                        - name: Obtain X-CRSF-TOKEN from auth.roblox.com
                          id: auth
                          working-directory: crsf
                          run: node index.js

                        - name: Deploy Stage
                          uses: fjogeleit/http-request-action@v1
                          with:
                                  url: 'https://data.roblox.com/Data/Upload.ashx?assetid=${{ env.assetId }}'
                                  method: 'POST'
                                  contentType: 'application/octet-stream'
                                  customHeaders: '{"User-Agent": "Roblox/WinInet", "X-CSRF-Token": "${{ steps.auth.outputs.CRSF-TOKEN }}"}, "Accept": "application/json", "Cookie": ".ROBLOSECURITY=${{ secrets.VSDS_ROBLOXSECURITYKEY }}"'
                                  files: '{ "file": "vsds-${{ github.ref_name }}.rbxm" }'
                                  timeout: 10000
                                  preventFailureOnNoResponse: 'true'
                        #- name: Publish VSDS V3 Development Version to roblox.com
                        #  run: rojo upload "/home/runner/work/VSDS-V3/VSDS-V3" --cookie "${{ secrets.VSDS_ROBLOXSECURITYKEY }}" --asset_id ${{ env.assetId }}

                        - uses: actions/upload-artifact@v4.3.1
                          with:
                                  name: VSDS V3 DEVELOPMENT BUILD
                                  path: vsds-${{ github.ref_name }}.rbxm
